generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  GUEST
  CAPTAIN
  BOTH
}

enum BoatPricingType {
  PRIVATE_HOURLY
  PER_PERSON
}

enum Rumbo {
  RUMBO_1
  RUMBO_2
  RUMBO_3
}

enum TripStatus {
  REQUESTED
  ACCEPTED
  ACTIVE
  COMPLETED
  CANCELED
}

enum LiveRideStatus {
  REQUESTED
  OFFERED
  ACCEPTED
  CANCELED
}

enum LiveRideOfferStatus {
  OFFERED
  REJECTED
  ACCEPTED
}

enum PaymentStatus {
  PENDING
  HELD
  PAID
  REFUNDED
  CANCELED
}

enum ReviewTargetType {
  CAPTAIN
  GUEST
}

enum IncidentType {
  MECHANICAL
  WEATHER
  EMERGENCY
  OTHER
}

enum NotificationType {
  TRIP_REQUESTED
  LIVE_RIDE_OFFER
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  firstName    String?
  lastName     String?
  dateOfBirth  DateTime?
  role         UserRole @default(GUEST)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  captain       Captain?
  tripsCreated  Trip[]            @relation("TripCreatedBy")
  participants  TripParticipant[]
  reviewsGiven  Review[]          @relation("ReviewAuthor")
  refreshTokens RefreshToken[]
  notifications Notification[]
  liveRideRequests LiveRideRequest[] @relation("LiveRideCreatedBy")
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique
  revokedAt   DateTime?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  replacedBy  String?  // token id that replaced this one (rotation)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Captain {
  id        String   @id @default(cuid())
  userId    String   @unique
  displayName String
  bio       String?
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  boats Boat[]
  liveRideOfferedRequests LiveRideRequest[] @relation("LiveRideOfferedTo")
  liveRideOffers LiveRideOffer[]
}

model Boat {
  id            String   @id @default(cuid())
  captainId     String
  name          String
  maxPassengers Int
  minimumHours  Int
  licenseRef    String? // file reference only
  insuranceRef  String? // file reference only
  liveRidesOn   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  captain  Captain      @relation(fields: [captainId], references: [id], onDelete: Cascade)
  pricings BoatPricing[]
  rumboPricings BoatRumboPricing[]
  photos   BoatPhoto[]
  trips    Trip[]
  liveRideOffers LiveRideOffer[]

  @@index([captainId])
}

model BoatRumboPricing {
  id             String   @id @default(cuid())
  boatId         String
  rumbo          Rumbo
  currency       String   @default("USD")
  hourlyRateCents Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  boat Boat @relation(fields: [boatId], references: [id], onDelete: Cascade)

  @@unique([boatId, rumbo])
  @@index([boatId])
  @@index([rumbo])
}

model BoatPhoto {
  id        String   @id @default(cuid())
  boatId    String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  boat Boat @relation(fields: [boatId], references: [id], onDelete: Cascade)

  @@index([boatId])
}

model BoatPricing {
  id           String          @id @default(cuid())
  boatId       String
  type         BoatPricingType
  currency     String          @default("USD")

  // PRIVATE_HOURLY
  privateHourlyRateCents Int?

  // PER_PERSON
  perPersonRateCents Int?

  minimumTripDurationHours Int
  activeFrom DateTime @default(now())
  activeTo   DateTime?
  createdAt  DateTime @default(now())

  boat Boat @relation(fields: [boatId], references: [id], onDelete: Cascade)

  @@index([boatId])
  @@index([activeFrom])
}

model Trip {
  id          String     @id @default(cuid())
  boatId      String
  createdById String
  status      TripStatus @default(REQUESTED)

  startAt   DateTime
  endAt     DateTime
  passengerCount Int @default(1)
  notes     String?

  // Snapshot of pricing at booking time (immutable history)
  pricingSnapshot Json

  subtotalCents  Int
  commissionRate Float // e.g. 0.18
  commissionCents Int
  totalCents     Int
  currency       String @default("USD")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boat       Boat             @relation(fields: [boatId], references: [id], onDelete: Restrict)
  createdBy  User             @relation("TripCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  participants TripParticipant[]
  payment    Payment?
  incidents  Incident[]
  reviews    Review[]
  notifications Notification[]
  liveRideRequest LiveRideRequest?

  @@index([boatId])
  @@index([createdById])
  @@index([status])
  @@index([startAt])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  tripId    String?
  liveRideRequestId String?
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: Cascade)
  liveRideRequest LiveRideRequest? @relation(fields: [liveRideRequestId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, readAt])
  @@index([createdAt])
}

model LiveRideRequest {
  id           String        @id @default(cuid())
  createdById  String
  pickupPoint  String
  rumbo        Rumbo
  passengerCount Int
  hours        Int
  hourlyRateCents Int
  subtotalCents Int
  commissionRate Float
  commissionCents Int
  totalCents   Int
  currency     String @default("USD")
  status       LiveRideStatus @default(REQUESTED)
  offeredToCaptainId String?
  tripId       String? @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  createdBy User @relation("LiveRideCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  offeredTo Captain? @relation("LiveRideOfferedTo", fields: [offeredToCaptainId], references: [id], onDelete: SetNull)
  offers LiveRideOffer[]
  notifications Notification[]
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: SetNull)

  @@index([createdById])
  @@index([status])
  @@index([offeredToCaptainId])
  @@index([createdAt])
}

model LiveRideOffer {
  id        String             @id @default(cuid())
  requestId String
  captainId String
  boatId    String
  status    LiveRideOfferStatus @default(OFFERED)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  request LiveRideRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  captain Captain @relation(fields: [captainId], references: [id], onDelete: Cascade)
  boat    Boat    @relation(fields: [boatId], references: [id], onDelete: Cascade)

  @@unique([requestId, captainId])
  @@index([captainId])
  @@index([status])
  @@index([createdAt])
}

model TripParticipant {
  id        String   @id @default(cuid())
  tripId    String
  userId    String
  createdAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([userId])
}

model Payment {
  id         String        @id @default(cuid())
  tripId     String        @unique
  status     PaymentStatus @default(PENDING)
  amountCents Int
  currency   String @default("USD")
  provider   String @default("stub")
  providerRef String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
}

model Review {
  id           String           @id @default(cuid())
  tripId       String
  authorId     String
  targetType   ReviewTargetType
  rating       Int
  comment      String?
  createdAt    DateTime @default(now())

  trip   Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  author User @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([authorId])
}

model Incident {
  id        String       @id @default(cuid())
  tripId    String
  type      IncidentType
  summary   String
  createdAt DateTime @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId])
}

